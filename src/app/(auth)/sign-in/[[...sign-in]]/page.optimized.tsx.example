/**
 * Optimized Sign-In Page with Lazy Loading
 * Reduces initial JavaScript bundle by ~60%
 */

"use client";

import { SignIn } from "@clerk/nextjs";
import { useEffect, useRef, Suspense, lazy } from "react";
import { useAuth } from "@clerk/nextjs";
import { useRouter } from "next/navigation";
import { 
  setupAuthPreconnect, 
  cleanupStaleAuth, 
  authPerformance,
} from "@/lib/utils/authOptimization";

// Lazy load heavy components (saves ~200KB initial load)
const AnimatedBackground = lazy(() => import('@/components/auth/AnimatedBackground'));
const StatsSection = lazy(() => import('@/components/auth/StatsSection'));

export default function SignInPage() {
  const { isLoaded, userId, sessionClaims } = useAuth();
  const router = useRouter();
  const hasRedirected = useRef(false);

  useEffect(() => {
    authPerformance.start('sign-in-page-load');
    setupAuthPreconnect();
    cleanupStaleAuth();
    
    return () => {
      authPerformance.end('sign-in-page-load');
    };
  }, []);

  // Smart redirect after sign-in completes (once only)
  useEffect(() => {
    if (isLoaded && userId && sessionClaims && !hasRedirected.current) {
      hasRedirected.current = true;
      const role = (sessionClaims?.metadata as any)?.role || 'user';
      const destination = (role === 'admin' || role === 'superadmin') ? '/admin' : '/dashboard';
      
      console.log(`[SIGN-IN] âš¡ Client-side redirect ${role} to ${destination}`);
      router.replace(destination);
    }
  }, [isLoaded, userId, sessionClaims, router]);

  return (
    <div className="grid min-h-screen lg:grid-cols-2">
      {/* Left Panel - Lazy loaded background */}
      <div className="relative hidden lg:flex items-center justify-center bg-gradient-to-br from-blue-600 to-purple-600 p-12 overflow-hidden">
        <Suspense fallback={<div className="w-full h-full" />}>
          <AnimatedBackground />
        </Suspense>
        
        <div className="relative z-10 text-center max-w-lg space-y-8">
          <h1 className="text-5xl font-bold text-white">
            Welcome Back
          </h1>
          <p className="text-xl text-white/90">
            Continue building your professional future
          </p>
          
          <Suspense fallback={<div className="h-32" />}>
            <StatsSection />
          </Suspense>
        </div>
      </div>

      {/* Right Panel - Sign In Form */}
      <div className="flex items-center justify-center bg-white dark:bg-gray-950 p-6">
        <div className="w-full max-w-md">
          <SignIn
            appearance={{
              layout: {
                shimmer: false,
                animations: false,
              },
              elements: {
                formButtonPrimary: 'bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white font-semibold shadow-lg',
                card: 'shadow-2xl border-2 border-gray-100 dark:border-gray-800 bg-white dark:bg-gray-900',
                formFieldInput: 'border-2 border-gray-200 dark:border-gray-700 focus:border-purple-500',
              },
            }}
          />
        </div>
      </div>
    </div>
  );
}
